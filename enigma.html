<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Enigma M4: Clear Logbook</title>
    <style>
        :root {
            --wood-dark: #2a1b12;
            --wood-light: #5d4037;
            --metal: #222;
            --paper: #fdfbf7;
            --ink-blue: #1a237e;
            --ink-black: #212121;
            --lamp-glow: #ffcc00;
        }

        * { box-sizing: border-box; user-select: none; }

        body {
            background-color: #000;
            color: #ccc;
            font-family: 'Courier New', monospace;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: start;
            min-height: 100vh;
            margin: 0;
            padding: 20px;
        }

        /* --- MESIN UTAMA --- */
        .machine-container {
            background: repeating-linear-gradient(45deg, var(--wood-dark), var(--wood-dark) 10px, var(--wood-light) 10px, var(--wood-light) 12px);
            padding: 15px;
            border-radius: 10px;
            box-shadow: 0 20px 50px rgba(0,0,0,0.8);
            border: 5px solid #150b07;
            width: 100%;
            max-width: 700px;
            margin-bottom: 20px;
            position: relative;
        }

        .plate {
            background: #222;
            background-image: radial-gradient(#333 15%, transparent 16%);
            background-size: 4px 4px;
            padding: 20px;
            border-radius: 5px;
            border: 2px solid #444;
            box-shadow: inset 0 0 30px #000;
        }

        /* --- ROTORS --- */
        .rotor-display {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-bottom: 20px;
            background: #111;
            padding: 10px;
            border-radius: 5px;
            border-bottom: 1px solid #555;
        }

        .rotor-unit { display: flex; flex-direction: column; align-items: center; }

        .window {
            width: 40px; height: 50px;
            background: linear-gradient(#ccc, #fff, #ccc);
            color: #000;
            font-size: 26px; font-weight: bold;
            display: flex; align-items: center; justify-content: center;
            border: 2px solid #000;
            margin: 5px 0;
            box-shadow: inset 0 2px 5px rgba(0,0,0,0.5);
        }

        .btn-rotor {
            background: #333; color: #aaa; border: 1px solid #555;
            width: 40px; cursor: pointer;
        }
        .btn-rotor:hover { background: #555; color: #fff; }

        /* --- LAMP & KEYBOARD --- */
        .row { display: flex; justify-content: center; gap: 8px; margin-bottom: 8px; }
        .row:nth-child(2) { margin-left: 15px; }
        .row:nth-child(3) { margin-left: -15px; }

        .lampboard { margin-bottom: 20px; }
        .lamp {
            width: 36px; height: 36px;
            border-radius: 50%;
            background: #1a1a1a;
            border: 2px solid #000;
            display: flex; align-items: center; justify-content: center;
            color: rgba(255,255,255,0.2);
            font-weight: bold;
            transition: all 0.2s;
        }
        .lamp.on {
            background: var(--lamp-glow);
            color: #4e3600;
            box-shadow: 0 0 20px var(--lamp-glow), inset 0 0 5px #fff;
            text-shadow: 0 0 2px #fff;
            border-color: #b7950b;
        }

        .keyboard { margin-bottom: 20px; }
        .key {
            width: 40px; height: 40px;
            border-radius: 50%;
            background: radial-gradient(circle at 30% 30%, #444, #111);
            border: 3px solid #000;
            color: #ddd;
            display: flex; align-items: center; justify-content: center;
            font-weight: bold;
            cursor: pointer;
            box-shadow: 0 4px 5px rgba(0,0,0,0.5);
            position: relative;
            top: 0;
        }
        .key:active, .key.pressed {
            top: 3px;
            box-shadow: 0 1px 2px rgba(0,0,0,0.5);
            background: #222;
        }

        /* --- PLUGBOARD --- */
        .plug-area {
            position: relative;
            background: #151515;
            padding: 10px;
            border-top: 1px solid #444;
        }
        .socket {
            display: flex; flex-direction: column; align-items: center; cursor: pointer;
        }
        .hole {
            width: 16px; height: 16px;
            background: #000; border: 2px solid #555; border-radius: 50%;
        }
        .socket:hover .hole { border-color: #999; }
        .socket.selected .hole { border-color: #0f0; box-shadow: 0 0 5px #0f0; }
        .socket.plugged .hole { background: #333; }
        .lbl { font-size: 8px; color: #666; margin-top: 2px; }

        #cables { position: absolute; top:0; left:0; width:100%; height:100%; pointer-events: none; z-index: 5; }
        path.wire { fill:none; stroke-width: 4; stroke-linecap: round; opacity: 0.8; filter: drop-shadow(0 2px 2px #000); }

        /* --- LOGBOOK (TAMPILAN BARU) --- */
        .logbook {
            width: 100%;
            max-width: 700px;
            background-color: var(--paper);
            color: #000;
            padding: 20px;
            box-shadow: 0 10px 20px rgba(0,0,0,0.5);
            font-family: 'Courier New', Courier, monospace;
            position: relative;
            /* Efek kertas sobek sedikit di atas */
            clip-path: polygon(0 0, 100% 1px, 100% 100%, 0% 100%);
            border-top: 10px solid #d7ccc8; /* Clip holder */
        }

        .log-header {
            text-align: center;
            border-bottom: 2px solid #000;
            padding-bottom: 10px;
            margin-bottom: 15px;
            font-weight: bold;
            letter-spacing: 2px;
            color: #444;
        }

        .log-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .log-section h3 {
            font-size: 14px;
            margin: 0 0 10px 0;
            text-transform: uppercase;
            color: #666;
            border-bottom: 1px dashed #aaa;
            padding-bottom: 5px;
        }

        .paper-text {
            width: 100%;
            min-height: 100px;
            font-size: 16px;
            line-height: 1.5;
            word-break: break-all;
            white-space: pre-wrap;
        }

        /* Warna teks berbeda agar mudah dibedakan */
        #log-input { color: var(--ink-black); }
        #log-output { color: var(--ink-blue); font-weight: bold; }

        .actions {
            margin-top: 15px;
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            border-top: 1px solid #ddd;
            padding-top: 10px;
        }

        .btn {
            background: #fff; border: 1px solid #ccc;
            padding: 5px 10px; font-family: inherit; cursor: pointer;
            font-size: 12px; color: #333;
            transition: 0.2s;
        }
        .btn:hover { background: #eee; border-color: #999; }
        .btn-danger { color: #d32f2f; border-color: #ef9a9a; }
        .btn-danger:hover { background: #ffebee; border-color: #d32f2f; }

    </style>
</head>
<body>

    <div class="machine-container">
        <h2 style="text-align:center; margin:0 0 15px 0; color:#555; text-shadow:0 1px 0 #000;">ENIGMA M4</h2>
        
        <div class="plate">
            <div class="rotor-display">
                <div class="rotor-unit">
                    <button class="btn-rotor" onclick="userRotate(0,1)">▲</button>
                    <div class="window" id="r0">A</div>
                    <button class="btn-rotor" onclick="userRotate(0,-1)">▼</button>
                </div>
                <div class="rotor-unit">
                    <button class="btn-rotor" onclick="userRotate(1,1)">▲</button>
                    <div class="window" id="r1">A</div>
                    <button class="btn-rotor" onclick="userRotate(1,-1)">▼</button>
                </div>
                <div class="rotor-unit">
                    <button class="btn-rotor" onclick="userRotate(2,1)">▲</button>
                    <div class="window" id="r2">A</div>
                    <button class="btn-rotor" onclick="userRotate(2,-1)">▼</button>
                </div>
            </div>

            <div class="lampboard" id="lamps"></div>

            <div class="keyboard" id="keys"></div>

            <div class="plug-area" id="plug-area">
                <svg id="cables"></svg>
                <div id="sockets"></div>
            </div>
        </div>
    </div>

    <div class="logbook">
        <div class="log-header">NACHRICHTEN LOGBUCH (LOG PESAN)</div>
        
        <div class="log-grid">
            <div class="log-section">
                <h3>Input (Teks Asli)</h3>
                <div id="log-input" class="paper-text"></div>
            </div>

            <div class="log-section">
                <h3>Output (Tereskripsi)</h3>
                <div id="log-output" class="paper-text"></div>
            </div>
        </div>

        <div class="actions">
            <button class="btn" onclick="copyText('log-output')">COPY OUTPUT</button>
            <button class="btn btn-danger" onclick="resetAll()">RESET TOTAL</button>
        </div>
    </div>

<script>
    // --- AUDIO SYSTEM ---
    const AudioContext = window.AudioContext || window.webkitAudioContext;
    let actx = new AudioContext();

    function sfx(type) {
        if (actx.state === 'suspended') actx.resume();
        const o = actx.createOscillator();
        const g = actx.createGain();
        o.connect(g); g.connect(actx.destination);
        const t = actx.currentTime;

        if(type === 'k') { // Keypress (Deep Thud)
            o.type = 'triangle';
            o.frequency.setValueAtTime(100, t);
            o.frequency.exponentialRampToValueAtTime(30, t+0.1);
            g.gain.setValueAtTime(0.4, t);
            g.gain.linearRampToValueAtTime(0, t+0.1);
            o.start(t); o.stop(t+0.1);
        } else { // Click
            o.type = 'square';
            o.frequency.setValueAtTime(600, t);
            g.gain.setValueAtTime(0.05, t);
            g.gain.linearRampToValueAtTime(0, t+0.03);
            o.start(t); o.stop(t+0.03);
        }
    }

    // --- ENIGMA CONFIG ---
    const alpha = "ABCDEFGHIJKLMNOPQRSTUVWXYZ";
    const layout = ["QWERTZUIO", "ASDFGHJK", "PYXCVBNML"];
    
    // Rotor I, II, III
    const rData = [
        { w: "BDFHJLCPRTXVZNYEIWGAKMUSQO", n: "V" }, 
        { w: "AJDKSIRUXBLHWTMCQGZNPYFVOE", n: "E" },
        { w: "EKMFLGDQVZNTOWYHXUSPAIBRCJ", n: "Q" }
    ];
    const refl = "YRUHQSLDPXNGOKMIEBFZCWVJAT"; // Reflector B

    let pos = [0, 0, 0];
    let plugs = new Map();
    let selSock = null;
    let charCount = 0; // Untuk grouping 4 huruf

    // --- SETUP ---
    window.onload = () => {
        makeBoard("lamps", "lamp", false);
        makeBoard("keys", "key", true);
        makeSockets();
        updRot();
        window.addEventListener('resize', drawCables);
    };

    function makeBoard(id, cls, interact) {
        const con = document.getElementById(id);
        layout.forEach(row => {
            const d = document.createElement("div");
            d.className = "row";
            for(let c of row) {
                const el = document.createElement("div");
                el.className = cls;
                el.id = `${cls}-${c}`;
                el.innerText = c;
                if(interact) {
                    el.onmousedown = () => press(c);
                    el.onmouseup = () => release(c);
                    el.onmouseleave = () => release(c);
                }
                d.appendChild(el);
            }
            con.appendChild(d);
        });
    }

    // --- LOGIC ---
    function mod(n, m) { return ((n % m) + m) % m; }
    function c2i(c) { return c.charCodeAt(0) - 65; }
    function i2c(i) { return String.fromCharCode(i + 65); }

    function step() {
        const n1 = (alpha[pos[1]] === rData[1].n);
        const n2 = (alpha[pos[2]] === rData[2].n);
        
        if(n1) { pos[0]++; pos[1]++; }
        else if(n2) { pos[1]++; }
        pos[2]++;
        
        pos[0]%=26; pos[1]%=26; pos[2]%=26;
        sfx('r');
        updRot();
    }

    function crypt(char) {
        let sig = c2i(plugs.get(char) || char);
        step();
        
        // R to L
        for(let i=2; i>=0; i--) {
            let p = pos[i];
            let off = mod(sig + p, 26);
            let map = c2i(rData[i].w[off]);
            sig = mod(map - p, 26);
        }
        // Refl
        sig = c2i(refl[sig]);
        // L to R
        for(let i=0; i<=2; i++) {
            let p = pos[i];
            let target = i2c(mod(sig + p, 26));
            let idx = rData[i].w.indexOf(target);
            sig = mod(idx - p, 26);
        }
        let res = i2c(sig);
        return plugs.get(res) || res;
    }

    // --- INTERACTION ---
    let active = null;
    function press(c) {
        if(active) return;
        document.getElementById(`key-${c}`).classList.add('pressed');
        sfx('k');
        
        let res = crypt(c);
        let l = document.getElementById(`lamp-${res}`);
        l.classList.add('on');
        active = c;

        updateLog(c, res);
    }

    function release(c) {
        document.getElementById(`key-${c}`).classList.remove('pressed');
        document.querySelectorAll('.lamp.on').forEach(e => e.classList.remove('on'));
        active = null;
    }

    function userRotate(idx, dir) {
        pos[idx] = mod(pos[idx] + dir, 26);
        sfx('r');
        updRot();
    }

    function updRot() {
        [0,1,2].forEach(i => document.getElementById(`r${i}`).innerText = alpha[pos[i]]);
    }

    // --- NEW LOGBOOK SYSTEM ---
    function updateLog(inChar, outChar) {
        const inEl = document.getElementById('log-input');
        const outEl = document.getElementById('log-output');

        // Logic grouping 4 huruf
        if (charCount > 0 && charCount % 4 === 0) {
            inEl.innerText += ' ';
            outEl.innerText += ' ';
        }

        inEl.innerText += inChar;
        outEl.innerText += outChar;
        
        charCount++;
    }

    function copyText(id) {
        const text = document.getElementById(id).innerText;
        navigator.clipboard.writeText(text).then(() => alert("Teks berhasil disalin!"));
    }

    function resetAll() {
        pos = [0,0,0];
        plugs.clear();
        document.getElementById('log-input').innerText = "";
        document.getElementById('log-output').innerText = "";
        charCount = 0;
        updRot();
        drawCables();
    }

    // --- PLUGBOARD ---
    function makeSockets() {
        const con = document.getElementById("sockets");
        layout.forEach(row => {
            const d = document.createElement("div");
            d.className = "row";
            for(let c of row) {
                const s = document.createElement("div");
                s.className = "socket";
                s.id = `soc-${c}`;
                s.onclick = () => sockClick(c);
                s.innerHTML = `<div class="hole"></div><div class="lbl">${c}</div>`;
                d.appendChild(s);
            }
            con.appendChild(d);
        });
    }

    function sockClick(c) {
        if(plugs.has(c)) {
            let p = plugs.get(c);
            plugs.delete(c); plugs.delete(p);
        } else {
            if(!selSock) {
                selSock = c;
                document.getElementById(`soc-${c}`).classList.add('selected');
            } else if(selSock === c) {
                selSock = null;
                document.getElementById(`soc-${c}`).classList.remove('selected');
            } else {
                plugs.set(selSock, c); plugs.set(c, selSock);
                document.getElementById(`soc-${selSock}`).classList.remove('selected');
                selSock = null;
                sfx('r');
            }
        }
        drawCables();
    }

    function drawCables() {
        const svg = document.getElementById("cables");
        svg.innerHTML = "";
        const area = document.getElementById("plug-area").getBoundingClientRect();
        const done = new Set();
        const colors = ["#d32f2f", "#1976d2", "#388e3c", "#fbc02d", "#7b1fa2"];

        plugs.forEach((v, k) => {
            let id = [k,v].sort().join("");
            if(done.has(id)) return;
            done.add(id);

            let r1 = document.getElementById(`soc-${k}`).getBoundingClientRect();
            let r2 = document.getElementById(`soc-${v}`).getBoundingClientRect();
            
            let x1 = r1.left+r1.width/2 - area.left;
            let y1 = r1.top+r1.height/2 - area.top;
            let x2 = r2.left+r2.width/2 - area.left;
            let y2 = r2.top+r2.height/2 - area.top;

            let path = document.createElementNS("http://www.w3.org/2000/svg", "path");
            let mx = (x1+x2)/2, my = Math.max(y1,y2) + 30 + Math.abs(x1-x2)*0.2;
            
            path.setAttribute("d", `M ${x1} ${y1} Q ${mx} ${my} ${x2} ${y2}`);
            path.setAttribute("class", "wire");
            path.setAttribute("stroke", colors[(k.charCodeAt(0)+v.charCodeAt(0))%5]);
            svg.appendChild(path);
        });
        
        document.querySelectorAll('.socket').forEach(s => s.classList.remove('plugged'));
        plugs.forEach((v,k) => document.getElementById(`soc-${k}`).classList.add('plugged'));
    }

    document.addEventListener("keydown", e => {
        let k = e.key.toUpperCase();
        if(alpha.includes(k) && !e.repeat && !e.ctrlKey) press(k);
    });
    document.addEventListener("keyup", e => {
        let k = e.key.toUpperCase();
        if(alpha.includes(k)) release(k);
    });
</script>
</body>
</html>